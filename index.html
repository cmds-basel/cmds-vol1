<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>mindar-p5js-example-sw</title>

  <!-- disable following 3 lines for production -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- load MindAR + A-Frame + custom p5.js + your sketch -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
  <script src="js/p5.min.js"></script>
  <script src="js/sketch.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- A-Frame keep loading latest output of canvas -->
  <script type="text/javascript">
    console.log('ready!')

    const targetVideoMap = {
      0: ["kFjnF1E8uGY", "U0FHTbmM_jI"], 
      1: ["Bv1jgyuu7Dk", "1RkBEPVzVxY"], 
      2: ["TFj-tgLIxJ8"], 
      3: ["d1sN2V-5AD0"], 
      4: ["f8UKLtQYhUk"], 
      5: ["29lazCsvsPw"], 
      6: ["-Q9jlS7l-h0"], 
      7: ["bESn3UQdci0"],
      8: ["S0P7iYdgvcE"]
    };

    let player;
    let playerReady = false;
    let pendingVideoId = null;
    let currentVideoIndex = {};

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('videoFrame', {
        events: {
          'onReady': onPlayerReady
        }
      });
    }

    function onPlayerReady(event) {
      console.log('YouTube Player is ready.');
      playerReady = true;
      if (pendingVideoId) {
        player.loadVideoById(pendingVideoId);
        player.playVideo();
        pendingVideoId = null;
      }
    }

    function playVideo(targetIndex) {
      const videoIds = targetVideoMap[targetIndex];
      if (videoIds) {
        if (!currentVideoIndex[targetIndex]) {
          currentVideoIndex[targetIndex] = 0;
        }
        const videoId = videoIds[currentVideoIndex[targetIndex] % videoIds.length];
        currentVideoIndex[targetIndex]++;
        if (playerReady) {
          player.loadVideoById(videoId);
          player.playVideo();
        } else {
          console.error('Player is not ready yet. Will play when ready.');
          pendingVideoId = videoId;
        }
      }
    }

    function pauseVideo() {
      if (playerReady) {
        player.pauseVideo();
      }
    }

    AFRAME.registerComponent('canvas-updater', {
      dependencies: ['geometry', 'material'],

      tick: function () {
        var material, el = this.el;
        material = el.getObject3D('mesh').material;
        if (!material.map) { return; }
          material.map.needsUpdate = true;
      }
    });

    AFRAME.registerComponent('target-visible', {
      schema: {
        targetIndex: {type: 'int'}
      },
      init: function() {
        this.el.addEventListener('targetFound', () => {
          const targetIndex = this.data.targetIndex;
          console.log(`Target Found: ${targetIndex}`);
          playVideo(targetIndex);
          let vidPlayer = document.getElementById('vidPlayer');
          vidPlayer.style.display = 'block';
        });

        this.el.addEventListener('targetLost', () => {
          console.log('Target Lost');
          pauseVideo();
          let vidPlayer = document.getElementById('vidPlayer');
          vidPlayer.style.display = 'none';
        });
      }
    });
  </script>
  <style type="text/css">
    /* prevent user select on long touch */
    body {
      background: #000;
      -webkit-user-select: none; /* Safari */
      -ms-user-select: none; /* IE 10 and IE 11 */
      user-select: none; /* Standard syntax */
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevent scrolling */
    }
    #vidPlayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%; /* Ensure the video player covers the entire viewport */
      height: 100%; /* Ensure the video player covers the entire viewport */
      pointer-events: none;
      z-index: 1; /* Ensure it's above the AR content */
      display: none; /* Initially hidden */
    }
    iframe {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

  <!-- our canvas to load p5.js into -->
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>
  <div id="vidPlayer">
    <iframe id="videoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/?enablejsapi=1&rel=0&mute=1&autoplay=1&loop=1&controls=0" frameborder="0" allow="autoplay; encrypted-media;" allowfullscreen></iframe>
  </div>
  
  <!-- MindAR + A-Frame tracking -->
  <a-scene mindar-image="imageTargetSrc: data/targets.mind?2; filterMinCF: 0.0001; filterBeta: 0.05;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <!-- Repeat the following a-entity block for each target -->
    <a-entity mindar-image-target="targetIndex: 0" target-visible="targetIndex: 0">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 1" target-visible="targetIndex: 1">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 2" target-visible="targetIndex: 2">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 3" target-visible="targetIndex: 3">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 4" target-visible="targetIndex: 4">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 5" target-visible="targetIndex: 5">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 6" target-visible="targetIndex: 6">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 7" target-visible="targetIndex: 7">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
    <a-entity mindar-image-target="targetIndex: 8" target-visible="targetIndex: 8">
      <a-plane position="0 0 0" scale="1.05 1.05 1.05" height="1.4145" width="1" rotation="0 0 0" material="src:#canvas" canvas-updater></a-plane>
    </a-entity>
  </a-scene>
</body>
</html>
